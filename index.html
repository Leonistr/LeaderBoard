<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            text-align: center;
        }
        .leaderboard-container {
            width: 90%;
            max-width: 800px;
            margin: auto;
        }
        canvas {
            background: transparent;
        }
    </style>
</head>
<body>
    <div class="leaderboard-container">
        <h1>Leaderboard по группам</h1>
        <canvas id="leaderboardChart"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0JQp2C6LFeKVnaogjdXRKJJiwlfPjYy4",
            authDomain: "ekeb-14711.firebaseapp.com",
            projectId: "ekeb-14711",
            storageBucket: "ekeb-14711.appspot.com",
            messagingSenderId: "344039659889",
            appId: "1:344039659889:web:ef6a68a841db89b51c3ed0",
            measurementId: "G-JJDG0K5VYR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Список всех групп
        let groupScores = {
            "101": 0, "102": 0, "103": 0, "104": 0, "105": 0, "106": 0, "107": 0, "108": 0, "109": 0, "110": 0,
            "111": 0, "112": 0, "201": 0, "202": 0, "203": 0, "204": 0, "205": 0, "206": 0, "207": 0, "208": 0, "209": 0,
            "210": 0, "211": 0, "212": 0, "301": 0, "302": 0, "303": 0, "304": 0, "305": 0, "306": 0, "307": 0, "308": 0,
            "309": 0, "310": 0, "311": 0, "312": 0, "403": 0, "404": 0
        };

        // Генерация разных цветов для групп
        function getRandomColor() {
            return `hsl(${Math.random() * 360}, 70%, 60%)`;
        }
        let groupColors = {};
        Object.keys(groupScores).forEach(group => {
            groupColors[group] = getRandomColor();
        });

        const ctx = document.getElementById("leaderboardChart").getContext("2d");

        const chart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    label: "Общий счёт",
                    data: [],
                    backgroundColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // Горизонтальные полосы
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: {
                            color: "rgba(255, 255, 255, 0.2)"
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                },
                animation: {
                    duration: 1000
                }
            }
        });

        async function updateLeaderboard() {
            const querySnapshot = await getDocs(collection(db, "quiz_results"));
            
            // Обнуление перед подсчётом
            for (let group in groupScores) {
                groupScores[group] = 0;
            }

            querySnapshot.forEach(doc => {
                const data = doc.data();
                if (groupScores[data.group] !== undefined) {
                    groupScores[data.group] += data.score;
                }
            });

            // Отфильтровать группы с нулевым счётом
            let filteredGroups = Object.keys(groupScores).filter(group => groupScores[group] > 0);
            let filteredScores = filteredGroups.map(group => groupScores[group]);
            let filteredColors = filteredGroups.map(group => groupColors[group]);

            chart.data.labels = filteredGroups;
            chart.data.datasets[0].data = filteredScores;
            chart.data.datasets[0].backgroundColor = filteredColors;
            chart.update();
        }

        // Подписка на изменения в Firestore
        onSnapshot(collection(db, "quiz_results"), () => {
            updateLeaderboard();
        });

        updateLeaderboard();
    </script>
</body>
</html>
